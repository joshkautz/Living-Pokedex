# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

# Reference
# https://github.com/marketplace/actions/deploy-to-firebase-hosting

name: Deploy to Firebase Hosting Preview Channel
'on': pull_request
jobs:
  build_and_preview:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    outputs:
      output3: ${{ steps.step3.outputs.urls }}
    steps:

      - name: Check out Repository
        uses: actions/checkout@v3

      - name: Build Project
        run: npm ci && PUBLIC_URL=./ npm run build

      - name: Deploy to Firebase Hosting Preview Channel
        id: deploy_firebase_hosting_channel
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_LIVING_POKEDEX_DE070 }}'
          projectId: living-pokedex-de070

      - name: Add Firebase Hosting Preview Channel URL to API Key restrictions
        env:
          API_KEY_SERVICE_ACCOUNT: ${{ secrets.API_KEY_SERVICE_ACCOUNT_LIVING_POKEDEX_DE070 }}
        run: |
          wget https://storage.googleapis.com/oauth2l/latest/linux_amd64.tgz
          tar -xvzf linux_amd64.tgz
          echo "$API_KEY_SERVICE_ACCOUNT" >> ~/credentials.json
          shopt -s expand_aliases
          alias gcurl='curl -H "$(./linux_amd64/oauth2l header --json ~/credentials.json cloud-platform userinfo.email)" -H "Content-Type: application/json"'
          preview_url="${{ steps.deploy_firebase_hosting_channel.outputs.details_url }}"
          preview_url=${preview_url#*//}
          allowedReferrers=$(gcurl https://apikeys.googleapis.com/v2/projects/285902590177/locations/global/keys/6003ecc6-a4eb-4405-be8c-076dd74b53d1 | jq -r '.restrictions.browserKeyRestrictions.allowedReferrers[]')
          allowedReferrers="$allowedReferrers $preview_url"
          allowedReferrers=$(for i in ${allowedReferrers}; do echo "\"$i\","; done;)
          allowedReferrers=${allowedReferrers::-1}
          gcurl https://apikeys.googleapis.com/v2/projects/285902590177/locations/global/keys/6003ecc6-a4eb-4405-be8c-076dd74b53d1?updateMask=restrictions --request PATCH --data '{ "restrictions" : { "browserKeyRestrictions" : { "allowedReferrers" : [ '"$allowedReferrers"' ]}}}'
